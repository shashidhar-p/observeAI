# =============================================================================
# Bazel CI/CD Workflow for observeAI
# =============================================================================
#
# This workflow:
# - Builds all targets on every PR and push to main
# - Runs all tests on every PR and push to main
# - Pushes container images on push to main
# - Uses remote caching via GitHub Actions cache
#
# =============================================================================

name: Bazel CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push container images to registry'
        required: false
        default: 'false'
        type: boolean

# Ensure only one workflow runs at a time for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Container registry
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository_owner }}/observeai-backend
  IMAGE_NAME_DASHBOARD: ${{ github.repository_owner }}/observeai-dashboard

jobs:
  # ===========================================================================
  # Build Job
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git stamping

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.0
        with:
          # Enable disk cache
          disk-cache: ${{ github.workflow }}
          # Enable repository cache
          repository-cache: true
          # Bazelisk version management
          bazelisk-cache: true

      - name: Build all targets
        run: bazel build //... --config=ci

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            bazel-bin/src/backend
            bazel-bin/dashboard/dist
          retention-days: 7

  # ===========================================================================
  # Test Job
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.0
        with:
          disk-cache: ${{ github.workflow }}
          repository-cache: true
          bazelisk-cache: true

      - name: Run all tests
        run: bazel test //... --config=ci --test_output=errors

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: bazel-testlogs/**/*.xml
          retention-days: 7

  # ===========================================================================
  # Container Push Job (only on main branch)
  # ===========================================================================
  push-containers:
    name: Push Containers
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' || github.event.inputs.push_images == 'true'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.0
        with:
          disk-cache: ${{ github.workflow }}
          repository-cache: true
          bazelisk-cache: true

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build container images
        run: |
          bazel build //containers:backend_image --config=ci --config=stamp
          bazel build //containers:dashboard_image --config=ci --config=stamp

      - name: Push backend image
        run: bazel run //containers:backend_push --config=ci --config=stamp

      - name: Push dashboard image
        run: bazel run //containers:dashboard_push --config=ci --config=stamp

      - name: Output image digests
        id: digest
        run: |
          echo "backend_digest=$(bazel query --output=build //containers:backend_image | grep digest)" >> $GITHUB_OUTPUT
          echo "dashboard_digest=$(bazel query --output=build //containers:dashboard_image | grep digest)" >> $GITHUB_OUTPUT

    outputs:
      backend_image_digest: ${{ steps.digest.outputs.backend_digest }}
      dashboard_image_digest: ${{ steps.digest.outputs.dashboard_digest }}

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Bazel CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
